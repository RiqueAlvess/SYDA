<script>
  // Break big DOMContentLoaded callback into a top-level function
  // and multiple smaller subfunctions to reduce complexity.

  document.addEventListener('DOMContentLoaded', onDomReady);

  let activeLogs = [];
  let activeSyncPolling = true;
  let currentLogId = null;

  function onDomReady() {
    // 1) Initialize references to DOM elements
    initializeReferences();

    // 2) Collect all active logs
    collectActiveLogs();

    // 3) Possibly start polling if we have active logs
    maybeStartPolling();

    // 4) Attach event listeners
    attachGlobalEventListeners();
    attachTableEventListeners();

    // 5) Show/hide active sync panel
    updateActiveSyncsPanel();
  }

  // ----------------------------------------------
  // 1) Initialize references to DOM elements
  // ----------------------------------------------
  function initializeReferences() {
    window.deleteLogModal = new bootstrap.Modal(document.getElementById('deleteLogModal'));
    window.stopSyncModal = new bootstrap.Modal(document.getElementById('stopSyncModal'));
    window.logDetailsModal = new bootstrap.Modal(document.getElementById('logDetailsModal'));

    window.syncEmployeesBtn = document.getElementById('sync-employees-btn');
    window.syncAbsencesBtn = document.getElementById('sync-absences-btn');
    window.logsTableBody = document.querySelector('#logs-table-body');
  }

  // ----------------------------------------------
  // 2) Collect active logs
  // ----------------------------------------------
  function collectActiveLogs() {
    document
      .querySelectorAll('.sync-log-row[data-is-complete="false"]')
      .forEach(row => {
        activeLogs.push(parseInt(row.getAttribute('data-log-id')));
      });
  }

  // ----------------------------------------------
  // 3) Possibly start polling
  // ----------------------------------------------
  function maybeStartPolling() {
    if (activeLogs.length === 0) {
      // No logs to poll
      return;
    }
    // If logs exist, start the polling loop
    const pollingInterval = setInterval(() => {
      if (!activeSyncPolling) {
        clearInterval(pollingInterval);
        return;
      }
      updateActiveLogs();
    }, 2000);

    // Stop polling on page unload
    window.addEventListener('beforeunload', () => {
      activeSyncPolling = false;
      clearInterval(pollingInterval);
    });
  }

  // ----------------------------------------------
  // 4) Attach event listeners for Sync buttons
  // ----------------------------------------------
  function attachGlobalEventListeners() {
    if (syncEmployeesBtn) {
      syncEmployeesBtn.addEventListener('click', () => startSync('employees'));
    }
    if (syncAbsencesBtn) {
      syncAbsencesBtn.addEventListener('click', () => startSync('absences'));
    }

    document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
      if (currentLogId) {
        deleteLog(currentLogId);
      }
    });

    document.getElementById('confirmStopBtn')?.addEventListener('click', () => {
      if (currentLogId) {
        stopSync(currentLogId);
      }
    });
  }

  // ----------------------------------------------
  // 5) Attach event listeners for the logs table
  // ----------------------------------------------
  function attachTableEventListeners() {
    if (!logsTableBody) return;

    logsTableBody.addEventListener('click', function(e) {
      // Distinguish each button type
      if (e.target.closest('.delete-log-btn')) {
        handleDeleteLogClick(e);
      } else if (e.target.closest('.stop-sync-btn')) {
        handleStopSyncClick(e);
      } else if (e.target.closest('[data-bs-toggle="modal"][data-bs-target="#logDetailsModal"]')) {
        handleLogDetailsClick(e);
      }
    });
  }

  // *** Sub-handlers for Table Clicks ***

  function handleDeleteLogClick(e) {
    const btn = e.target.closest('.delete-log-btn');
    currentLogId = btn.getAttribute('data-log-id');
    window.deleteLogModal.show();
  }

  function handleStopSyncClick(e) {
    const btn = e.target.closest('.stop-sync-btn');
    currentLogId = btn.getAttribute('data-log-id');
    window.stopSyncModal.show();
  }

  function handleLogDetailsClick(e) {
    const btn = e.target.closest('[data-bs-toggle="modal"][data-bs-target="#logDetailsModal"]');
    const logId = btn.getAttribute('data-log-id');
    loadLogDetails(logId);
  }

  // ----------------------------------------------
  // 6) Show/hide the active sync panel
  // ----------------------------------------------
  function updateActiveSyncsPanel() {
    const activeSyncsDiv = document.getElementById('active-syncs');
    if (activeLogs.length > 0) {
      activeSyncsDiv.classList.remove('d-none');
      const syncContent = document.getElementById('active-syncs-content');
      syncContent.innerHTML = '';
      activeLogs.forEach(logId => addSyncContent(syncContent, logId));
    } else {
      activeSyncsDiv.classList.add('d-none');
    }
  }

  function addSyncContent(syncContent, logId) {
    const logRow = document.getElementById(`log-row-${logId}`);
    if (!logRow) return;

    const logType = logRow.querySelector('td:nth-child(2)')?.textContent || '';
    const logCompany = logRow.querySelector('td:nth-child(3)')?.textContent || '';
    const progressHtml = `
      <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
              <strong>${logType} - ${logCompany}</strong>
              <button class="btn btn-sm btn-danger stop-sync-btn" data-log-id="${logId}">
                  <i class="fas fa-stop"></i> Parar
              </button>
          </div>
          <div class="progress" style="height: 20px;">
              <div id="active-progress-${logId}" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                  role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  <span id="active-progress-text-${logId}">Iniciando...</span>
              </div>
          </div>
          <div id="active-message-${logId}" class="small text-muted mt-1">
              Iniciando sincronização...
          </div>
      </div>
    `;
    syncContent.innerHTML += progressHtml;
  }

  // ----------------------------------------------
  // 7) Polling function to update logs
  // ----------------------------------------------
  function updateActiveLogs() {
    const currentActiveLogs = [...activeLogs];
    currentActiveLogs.forEach(logId => {
      fetch(`/employees/sync-status/${logId}/`)
        .then(response => {
          if (!response.ok) throw new Error('Erro ao buscar status');
          return response.json();
        })
        .then(data => {
          updateLogUI(logId, data);
          if (data.completed) removeCompletedLog(logId);
        })
        .catch(error => console.error('Erro ao atualizar log:', error));
    });
  }

  function removeCompletedLog(logId) {
    const idx = activeLogs.indexOf(logId);
    if (idx > -1) {
      activeLogs.splice(idx, 1);
    }
    if (activeLogs.length === 0) {
      document.getElementById('active-syncs').classList.add('d-none');
    }
  }

  // ----------------------------------------------
  // 8) Update UI for a single log
  // ----------------------------------------------
  function updateLogUI(logId, data) {
    // Many of these DOM references may not exist if the row is gone
    const statusBadge = document.getElementById(`status-badge-${logId}`);
    const progressBar = document.getElementById(`progress-bar-${logId}`);
    const syncMessage = document.getElementById(`sync-message-${logId}`);
    const recordsCount = document.getElementById(`records-count-${logId}`);
    const endTimeEl = document.getElementById(`end-time-${logId}`);
    const activeProgress = document.getElementById(`active-progress-${logId}`);
    const activeProgressText = document.getElementById(`active-progress-text-${logId}`);
    const activeMessage = document.getElementById(`active-message-${logId}`);

    const percent = calcProgressPercent(data);

    if (activeProgress) {
      updateActiveProgressUI(activeProgress, activeProgressText, activeMessage, data, percent);
    }
    if (data.completed) {
      finalizeLogUI(logId, data);
    } else if (progressBar) {
      progressBar.style.width = `${percent}%`;
    }
    if (recordsCount && data.records_processed > 0) {
      recordsCount.textContent = `${data.records_success}/${data.records_processed}`;
    }
    if (syncMessage && data.error_message) {
      syncMessage.textContent = data.error_message;
    }
    if (endTimeEl && data.end_time && data.completed) {
      endTimeEl.textContent = formatTime(data.end_time);
    }
  }

  function calcProgressPercent(data) {
    if (data.records_processed > 0 && data.records_success > 0) {
      return (data.records_success / data.records_processed) * 100;
    }
    return 0;
  }

  function updateActiveProgressUI(bar, barText, msgEl, data, percent) {
    bar.style.width = `${percent}%`;
    bar.setAttribute('aria-valuenow', percent);
    if (data.records_processed > 0) {
      barText.textContent = `${data.records_success}/${data.records_processed} (${Math.round(percent)}%)`;
    } else {
      barText.textContent = 'Iniciando...';
    }
    if (data.error_message) {
      msgEl.textContent = data.error_message;
    }
  }

  function finalizeLogUI(logId, data) {
    // Update status badge
    const statusBadge = document.getElementById(`status-badge-${logId}`);
    if (statusBadge) {
      let { cssClass, text } = getStatusBadgeProps(data.status);
      statusBadge.className = `badge ${cssClass} status-badge`;
      statusBadge.innerHTML = text;
    }
    // Update progress bar
    const progressBar = document.getElementById(`progress-bar-${logId}`);
    if (progressBar) {
      progressBar.style.width = '100%';
      let finalClass = 'bg-info';
      if (data.status === 'success') finalClass = 'bg-success';
      else if (data.status === 'error') finalClass = 'bg-danger';
      progressBar.className = `sync-progress-bar ${finalClass}`;
    }
    // Remove stop button
    removeStopSyncButton(logId);

    // Reload after short delay
    setTimeout(() => window.location.reload(), 2000);
  }

  function removeStopSyncButton(logId) {
    const row = document.getElementById(`log-row-${logId}`);
    if (!row) return;

    const actionsCell = row.querySelector('td:last-child');
    const stopButton = actionsCell?.querySelector('.stop-sync-btn');
    if (stopButton) stopButton.remove();
  }

  function getStatusBadgeProps(status) {
    let cssClass = 'bg-info';
    let text = 'Parcial';
    if (status === 'success') {
      cssClass = 'bg-success';
      text = 'Sucesso';
    } else if (status === 'error') {
      cssClass = 'bg-danger';
      text = 'Erro';
    }
    return { cssClass, text };
  }

  // ----------------------------------------------
  // 9) Start sync (employees or absences)
  // ----------------------------------------------
  function startSync(type) {
    const isEmployees = type === 'employees';
    const url = isEmployees ? '{% url "sync_employees" %}' : '{% url "sync_absences" %}';
    const button = isEmployees ? syncEmployeesBtn : syncAbsencesBtn;

    if (!button) return;
    const originalText = button.innerHTML;
    button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Iniciando...`;
    button.disabled = true;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(r => r.json())
    .then(data => {
      button.innerHTML = originalText;
      button.disabled = false;
      handleSyncResponse(data);
    })
    .catch(err => {
      button.innerHTML = originalText;
      button.disabled = false;
      console.error('Erro:', err);
      showToast('Erro', 'Erro ao iniciar sincronização. Tente novamente mais tarde.', 'danger');
    });
  }

  function handleSyncResponse(data) {
    if (data.success) {
      if (data.sync_log_id) {
        activeLogs.push(data.sync_log_id);
        // If it's the first active log
        if (activeLogs.length === 1) {
          maybeStartPolling();
        }
        updateActiveSyncsPanel();
        // Reload quickly to show new log
        setTimeout(() => location.reload(), 500);
      }
      showToast('Sincronização', data.message, 'success');
    } else {
      showToast('Erro', data.message, 'danger');
    }
  }

  // ----------------------------------------------
  // 10) Load log details
  // ----------------------------------------------
  function loadLogDetails(logId) {
    const modalBody = document.querySelector('#logDetailsModal .modal-body');
    if (!modalBody) return;

    modalBody.innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p>Carregando detalhes...</p>
      </div>
    `;
    window.logDetailsModal.show();

    fetch(`/employees/sync-details/${logId}/`)
      .then(r => {
        if (!r.ok) throw new Error('Erro ao buscar detalhes');
        return r.json();
      })
      .then(data => fillLogDetailsModal(modalBody, data))
      .catch(err => {
        console.error('Erro ao carregar detalhes:', err);
        modalBody.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Erro ao carregar detalhes do log.
          </div>
        `;
      });
  }

  function fillLogDetailsModal(modalBody, data) {
    const startTime = formatDateTime(data.start_time);
    const endTime = data.end_time ? formatDateTime(data.end_time) : '-';
    const statusClass = data.status === 'success'
      ? 'success'
      : data.status === 'error'
      ? 'danger'
      : 'info';

    modalBody.innerHTML = `
      <div class="row mb-3">
        <div class="col-md-6">
          <h6>Informações Gerais</h6>
          <table class="table table-sm">
            <tr><th>Tipo:</th><td>${data.api_type === 'employee' ? 'Funcionários' : 'Absenteísmo'}</td></tr>
            <tr><th>Empresa:</th><td>${data.company}</td></tr>
            <tr><th>Status:</th><td><span class="badge bg-${statusClass}">${data.status_display}</span></td></tr>
            <tr><th>Início:</th><td>${startTime}</td></tr>
            <tr><th>Fim:</th><td>${endTime}</td></tr>
          </table>
        </div>
        <div class="col-md-6">
          <h6>Estatísticas</h6>
          <table class="table table-sm">
            <tr><th>Total Processados:</th><td>${data.records_processed}</td></tr>
            <tr><th>Sucessos:</th><td>${data.records_success}</td></tr>
            <tr><th>Erros:</th><td>${data.records_error}</td></tr>
            <tr><th>Taxa de Sucesso:</th><td>${data.records_processed > 0 ? Math.round((data.records_success / data.records_processed) * 100) : 0}%</td></tr>
            <tr><th>Duração:</th><td>${data.duration || '-'}</td></tr>
          </table>
        </div>
      </div>
      ${
        data.error_message
          ? `<div class="alert alert-${
              data.status === 'error' ? 'danger' : 'info'
            }"><h6>Mensagem do Sistema:</h6><pre class="mb-0">${data.error_message}</pre></div>`
          : ''
      }
    `;
  }

  // ----------------------------------------------
  // 11) Delete a log
  // ----------------------------------------------
  function deleteLog(logId) {
    showLoading();
    fetch(`/employees/sync-delete/${logId}/`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(r => r.json())
    .then(data => {
      hideLoading();
      window.deleteLogModal.hide();
      if (data.success) {
        removeLogRow(logId);
        showToast('Sucesso', 'Registro de sincronização excluído com sucesso!', 'success');
      } else {
        showToast('Erro', data.message || 'Erro ao excluir o registro.', 'danger');
      }
    })
    .catch(err => {
      hideLoading();
      window.deleteLogModal.hide();
      console.error('Erro:', err);
      showToast('Erro', 'Erro ao processar a requisição.', 'danger');
    });
  }

  function removeLogRow(logId) {
    const row = document.getElementById(`log-row-${logId}`);
    if (row) row.remove();

    // Remove from active logs if needed
    const index = activeLogs.indexOf(parseInt(logId));
    if (index > -1) {
      activeLogs.splice(index, 1);
      updateActiveSyncsPanel();
    }
  }

  // ----------------------------------------------
  // 12) Stop an ongoing sync
  // ----------------------------------------------
  function stopSync(logId) {
    showLoading();
    fetch(`/employees/sync-stop/${logId}/`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(r => r.json())
    .then(data => {
      hideLoading();
      window.stopSyncModal.hide();
      if (data.success) {
        handleStopSyncSuccess(logId);
      } else {
        showToast('Erro', data.message || 'Não foi possível interromper a sincronização.', 'danger');
      }
    })
    .catch(err => {
      hideLoading();
      window.stopSyncModal.hide();
      console.error('Erro:', err);
      showToast('Erro', 'Erro ao processar a requisição.', 'danger');
    });
  }

  function handleStopSyncSuccess(logId) {
    const idx = activeLogs.indexOf(parseInt(logId));
    if (idx > -1) {
      activeLogs.splice(idx, 1);
      updateActiveSyncsPanel();
    }

    const statusBadge = document.getElementById(`status-badge-${logId}`);
    if (statusBadge) {
      statusBadge.className = 'badge bg-warning status-badge';
      statusBadge.innerHTML = 'Interrompido';
    }

    const progressBar = document.getElementById(`progress-bar-${logId}`);
    if (progressBar) {
      progressBar.className = 'sync-progress-bar bg-warning';
      progressBar.style.width = '100%';
    }

    const endTimeCell = document.getElementById(`end-time-${logId}`);
    if (endTimeCell) endTimeCell.textContent = formatTime(new Date());

    removeStopSyncButton(logId);
    showToast('Sucesso', 'Sincronização interrompida com sucesso!', 'success');
  }

  // ----------------------------------------------
  // 13) Utility functions
  // ----------------------------------------------
  function showLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.style.display = 'flex';
  }

  function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.style.display = 'none';
  }

  function showToast(title, message, type = 'success') {
    const toastEl = document.getElementById('notification-toast');
    if (!toastEl) return;
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');

    toastTitle.textContent = title;
    toastMessage.innerHTML = message;
    toastEl.className = `toast text-white bg-${type}`;

    const toast = new bootstrap.Toast(toastEl, {
      autohide: true,
      delay: 5000
    });
    toast.show();
  }

  function formatTime(dateObj) {
    if (!dateObj) return '-';
    if (typeof dateObj === 'string') dateObj = new Date(dateObj);
    return dateObj.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function formatDateTime(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleString('pt-BR');
  }
</script>
