{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Absenteísmo | SYDA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    /* Estilos adicionais para os gráficos Plotly */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
        overflow: hidden;
    }
    
    /* Melhorar aparência do Plotly em tema claro */
    .js-plotly-plot .plotly .modebar {
        top: 5px;
        right: 5px;
    }
    
    /* Ajustes responsivos */
    @media (max-width: 768px) {
        .chart-container {
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="dashboard-header">
        <h1>Dashboard de Absenteísmo</h1>
        <p>Análise completa de absenteísmo corporativo</p>
    </div>

    {% if no_client %}
    <div class="alert alert-warning">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Nenhum cliente encontrado</h4>
        <p>Não foi possível carregar os dados de dashboard porque não há clientes cadastrados no sistema.</p>
        <hr>
        <p class="mb-0">Por favor, contate o administrador do sistema para cadastrar um cliente.</p>
    </div>
    {% elif no_data %}
    <div class="alert alert-info">
        <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i> Sem dados disponíveis</h4>
        <p>Não existem dados suficientes para gerar o dashboard. É necessário ter funcionários e registros de absenteísmo.</p>
        <hr>
        <p class="mb-0">Configure as APIs e sincronize os dados na seção <a href="{% url 'api_config' %}" class="alert-link">Configurações API</a>.</p>
    </div>
    {% else %}
    <!-- Métricas Principais -->
    <section class="metrics-grid">
        <div class="metric-card">
            <h2>Taxa de Absenteísmo</h2>
            <p class="metric-value text-blue">{{ absenteeism_rate }}%</p>
            <p class="metric-desc">Baseado na média de horas trabalhadas no Brasil</p>
        </div>
        
        <div class="metric-card">
            <h2>Custo Total</h2>
            <p class="metric-value text-green">R$ {{ absenteeism_cost|floatformat:2 }}</p>
            <p class="metric-desc">Baseado no salário mínimo de R$ 1.412,00</p>
        </div>
        
        <div class="metric-card">
            <h2>Dias de Afastamento</h2>
            <p class="metric-value text-orange">{{ total_days_off }}</p>
            <p class="metric-desc">Total de dias perdidos</p>
        </div>
        
        <div class="metric-card">
            <h2>Funcionários / Atestados</h2>
            <p class="metric-value text-purple">{{ total_employees }} / {{ total_absences }}</p>
            <p class="metric-desc">Total de funcionários e atestados</p>
        </div>
    </section>

    <!-- Gráficos - Primeira Linha -->
    <div class="charts-grid">
        <section class="chart-card">
            <h2>Top 10 Unidades com Maior Absenteísmo</h2>
            <div class="chart-container">
                {% if units_chart %}
                <div id="units-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
        
        <section class="chart-card">
            <h2>Absenteísmo por Setor</h2>
            <div class="chart-container">
                {% if departments_chart %}
                <div id="departments-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- Gráficos - Segunda Linha -->
    <div class="charts-grid">
        <section class="chart-card">
            <h2>Absenteísmo por Grupo Patológico</h2>
            <div class="chart-container">
                {% if cid_chart %}
                <div id="cid-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
        
        <section class="chart-card">
            <h2>Evolução do Absenteísmo por Mês</h2>
            <div class="chart-container">
                {% if month_chart %}
                <div id="month-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-line fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- Gráficos - Terceira Linha -->
    <div class="charts-grid">
        <section class="chart-card">
            <h2>Absenteísmo por Gênero</h2>
            <div class="gender-grid">
                <div class="chart-container">
                    {% if gender_chart %}
                    <div id="gender-chart"></div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-chart-pie fa-4x mb-3"></i>
                        <p>Dados insuficientes para gerar este gráfico</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="gender-stats">
                    <div class="stat-section">
                        <h3>Principais Grupos Patológicos por Gênero</h3>
                        
                        {% if gender_cid_data %}
                        <div class="gender-cid-tables">
                            {% for gender, cids in gender_cid_data.items %}
                            <div class="gender-cid-table">
                                <h4 style="color: {% cycle '#8E24AA' '#D81B60' '#1E88E5' %}">{{ gender }}</h4>
                                <table class="cid-table">
                                    <thead>
                                        <tr>
                                            <th>Grupo Patológico (CID)</th>
                                            <th>Qtde</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cid in cids %}
                                        <tr>
                                            <td>{{ cid.grupo_patologico|truncatechars:25 }}</td>
                                            <td>{{ cid.count }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-3 text-muted">
                            <p>Dados insuficientes para análise por gênero</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        
        <section class="chart-card">
            <h2>Análise de Custos do Absenteísmo</h2>
            <div class="cost-analysis">
                <div class="cost-section">
                    <h3>Premissas de Cálculo</h3>
                    <div class="cost-grid">
                        <div class="cost-item">
                            <p class="cost-label">Salário Mínimo Brasil:</p>
                            <p class="cost-value">R$ 1.412,00</p>
                        </div>
                        <div class="cost-item">
                            <p class="cost-label">Horas Mensais:</p>
                            <p class="cost-value">176 horas</p>
                        </div>
                        <div class="cost-item">
                            <p class="cost-label">Valor Hora Base:</p>
                            <p class="cost-value">R$ {{ hourly_rate|floatformat:2 }}</p>
                        </div>
                        <div class="cost-item">
                            <p class="cost-label">Total Horas Afastadas:</p>
                            <p class="cost-value">{{ total_hours_off }} horas</p>
                        </div>
                    </div>
                </div>
                
                <div class="cost-section">
                    <h3>Custo por Setor</h3>
                    <div class="chart-container">
                        {% if cost_chart %}
                        <div id="cost-chart"></div>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-chart-bar fa-4x mb-3"></i>
                            <p>Dados insuficientes para gerar este gráfico</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="cost-section">
                    <h3>Custo Total do Absenteísmo</h3>
                    <div class="total-cost-box">
                        <p class="total-cost-value">R$ {{ absenteeism_cost|floatformat:2 }}</p>
                        <p class="cost-percent">Representa aproximadamente {{ absenteeism_rate|floatformat:2 }}% de horas trabalhadas</p>
                    </div>
                </div>
                
                <div class="cost-section">
                    <h3>Projeção de Economia</h3>
                    <div class="savings-grid">
                        <div class="savings-card">
                            <h4>Economia com redução de 10%</h4>
                            <p class="savings-value">R$ {{ savings_10|floatformat:2 }}</p>
                        </div>
                        <div class="savings-card">
                            <h4>Economia com redução de 20%</h4>
                            <p class="savings-value">R$ {{ savings_20|floatformat:2 }}</p>
                        </div>
                        <div class="savings-card">
                            <h4>Economia com redução de 30%</h4>
                            <p class="savings-value">R$ {{ savings_30|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Carregar Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- Renderizar os gráficos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Renderizar gráfico de unidades
    {% if units_chart %}
    const unitsChart = JSON.parse('{{ units_chart|escapejs }}');
    Plotly.newPlot('units-chart', unitsChart.data, unitsChart.layout, {responsive: true});
    {% endif %}
    
    // Renderizar gráfico de departamentos
    {% if departments_chart %}
    const deptsChart = JSON.parse('{{ departments_chart|escapejs }}');
    Plotly.newPlot('departments-chart', deptsChart.data, deptsChart.layout, {responsive: true});
    {% endif %}
    
    // Renderizar gráfico de CID
    {% if cid_chart %}
    const cidChart = JSON.parse('{{ cid_chart|escapejs }}');
    Plotly.newPlot('cid-chart', cidChart.data, cidChart.layout, {responsive: true});
    {% endif %}
    
    // Renderizar gráfico mensal
    {% if month_chart %}
    const monthChart = JSON.parse('{{ month_chart|escapejs }}');
    Plotly.newPlot('month-chart', monthChart.data, monthChart.layout, {responsive: true});
    {% endif %}
    
    // Renderizar gráfico de gênero
    {% if gender_chart %}
    const genderChart = JSON.parse('{{ gender_chart|escapejs }}');
    Plotly.newPlot('gender-chart', genderChart.data, genderChart.layout, {responsive: true});
    {% endif %}
    
    // Renderizar gráfico de custos
    {% if cost_chart %}
    const costChart = JSON.parse('{{ cost_chart|escapejs }}');
    Plotly.newPlot('cost-chart', costChart.data, costChart.layout, {responsive: true});
    {% endif %}
    
    // Evento de redimensionamento para tornar os gráficos responsivos
    window.addEventListener('resize', function() {
        // Redimensionar todos os gráficos
        const charts = document.querySelectorAll('[id$="-chart"]');
        charts.forEach(chart => {
            Plotly.relayout(chart.id, {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        });
    });
});
</script>
{% endblock %}