{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Absenteísmo | SYDA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    /* Estilos adicionais para os gráficos Plotly */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
        overflow: hidden;
        border-radius: 0.5rem;
        background-color: white;
    }
    
    /* Estilos para os filtros */
    .filters-panel {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .filters-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .filters-title i {
        margin-right: 0.5rem;
    }
    
    .filter-input {
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        width: 100%;
        background-color: white;
        transition: border-color 0.15s ease-in-out;
    }
    
    .filter-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(87, 196, 229, 0.1);
    }
    
    .filter-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    
    .filter-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        height: 2.5rem;
        padding-left: 1rem;
        padding-right: 1rem;
        transition: all 0.2s;
    }
    
    .filter-btn-primary {
        background-color: var(--primary);
        color: white;
        border: none;
    }
    
    .filter-btn-primary:hover {
        background-color: var(--primary-dark);
    }
    
    .filter-btn-outline {
        background-color: transparent;
        color: var(--primary);
        border: 1px solid #e5e7eb;
    }
    
    .filter-btn-outline:hover {
        background-color: rgba(87, 196, 229, 0.05);
        border-color: var(--accent);
    }
    
    .filter-btn i {
        margin-right: 0.5rem;
    }
    
    /* Melhorar aparência do Plotly em tema claro */
    .js-plotly-plot .plotly .modebar {
        top: 5px;
        right: 5px;
    }
    
    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; /* Esconder por padrão */
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
        color: white;
    }
    
    /* Ajustes responsivos */
    @media (max-width: 768px) {
        .chart-container {
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="dashboard-header">
        <h1>Dashboard de Absenteísmo</h1>
        <p>Análise completa de absenteísmo corporativo</p>
    </div>

    <!-- Filtros do Dashboard -->
    <div class="filters-panel" id="dashboard-filters">
        <h2 class="filters-title"><i class="fas fa-filter"></i> Filtros</h2>
        <form id="filter-form" class="filter-form" method="GET">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="start-date" class="filter-label">Data Início</label>
                    <input type="date" id="start-date" class="filter-input" name="start_date">
                </div>
                <div class="col-md-3">
                    <label for="end-date" class="filter-label">Data Fim</label>
                    <input type="date" id="end-date" class="filter-input" name="end_date">
                </div>
                <div class="col-md-3">
                    <label for="unit-filter" class="filter-label">Unidade</label>
                    <select id="unit-filter" class="filter-input" name="unit">
                        <option value="">Todas as Unidades</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="department-filter" class="filter-label">Setor</label>
                    <select id="department-filter" class="filter-input" name="department">
                        <option value="">Todos os Setores</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label for="situation-filter" class="filter-label">Situação</label>
                    <select id="situation-filter" class="filter-input" name="situation">
                        <option value="">Todas as Situações</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="search-filter" class="filter-label">Buscar</label>
                    <input type="text" id="search-filter" class="filter-input" placeholder="Buscar por funcionário, matrícula..." name="search">
                </div>
                <div class="col-md-4" style="display: flex; align-items: flex-end;">
                    <div class="d-flex gap-2 w-100">
                        <button type="submit" id="apply-filters" class="filter-btn filter-btn-primary w-50">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button type="button" id="reset-filters" class="filter-btn filter-btn-outline w-50">
                            <i class="fas fa-undo"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <div id="active-filters" class="small"></div>
                    <div id="filtered-records" class="small text-muted mt-1"></div>
                </div>
            </div>
        </form>
    </div>

    {% if no_client %}
    <div class="alert alert-warning">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Nenhum cliente encontrado</h4>
        <p>Não foi possível carregar os dados de dashboard porque não há clientes cadastrados no sistema.</p>
        <hr>
        <p class="mb-0">Por favor, contate o administrador do sistema para cadastrar um cliente.</p>
    </div>
    {% elif no_data %}
    <div class="alert alert-info">
        <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i> Sem dados disponíveis</h4>
        <p>Não existem dados suficientes para gerar o dashboard. É necessário ter funcionários e registros de absenteísmo.</p>
        <hr>
        <p class="mb-0">Configure as APIs e sincronize os dados na seção <a href="{% url 'api_config' %}" class="alert-link">Configurações API</a>.</p>
    </div>
    {% else %}
    <!-- Métricas Principais -->
    <section class="metrics-grid">
        <div class="metric-card">
            <h2>Taxa de Absenteísmo</h2>
            <p class="metric-value text-blue">{{ absenteeism_rate }}%</p>
            <p class="metric-desc">Baseado na média de horas trabalhadas no Brasil</p>
        </div>
        
        <div class="metric-card">
            <h2>Custo Total</h2>
            <p class="metric-value text-green">R$ {{ absenteeism_cost|floatformat:2 }}</p>
            <p class="metric-desc">Baseado no salário mínimo de R$ 1.412,00</p>
        </div>
        
        <div class="metric-card">
            <h2>Dias de Afastamento</h2>
            <p class="metric-value text-orange">{{ total_days_off }}</p>
            <p class="metric-desc">Total de dias perdidos</p>
        </div>
        
        <div class="metric-card">
            <h2>Funcionários / Atestados</h2>
            <p class="metric-value text-purple">{{ total_employees }} / {{ total_absences }}</p>
            <p class="metric-desc">Total de funcionários e atestados</p>
        </div>
    </section>

    <!-- Gráficos - Primeira Linha -->
    <div class="charts-grid">
        <section class="chart-card">
            <h2>Top 10 Unidades com Maior Absenteísmo</h2>
            <div class="chart-container">
                {% if units_chart %}
                <div id="units-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
        
        <section class="chart-card">
            <h2>Absenteísmo por Setor</h2>
            <div class="chart-container">
                {% if departments_chart %}
                <div id="departments-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- Gráficos - Segunda Linha -->
    <div class="charts-grid">
        <section class="chart-card">
            <h2>Absenteísmo por Grupo Patológico</h2>
            <div class="chart-container">
                {% if cid_chart %}
                <div id="cid-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
        
        <section class="chart-card">
            <h2>Evolução do Absenteísmo por Mês</h2>
            <div class="chart-container">
                {% if month_chart %}
                <div id="month-chart"></div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-line fa-4x mb-3"></i>
                    <p>Dados insuficientes para gerar este gráfico</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- Gráficos - Terceira Linha -->
    <div class="charts-grid">
        <section class="chart-card">
            <h2>Absenteísmo por Gênero</h2>
            <div class="gender-grid">
                <div class="chart-container">
                    {% if gender_chart %}
                    <div id="gender-chart"></div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-chart-pie fa-4x mb-3"></i>
                        <p>Dados insuficientes para gerar este gráfico</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="gender-stats">
                    <div class="stat-section">
                        <h3>Principais Grupos Patológicos por Gênero</h3>
                        
                        {% if gender_cid_data %}
                        <div class="gender-cid-tables">
                            {% for gender, cids in gender_cid_data.items %}
                            <div class="gender-cid-table">
                                <h4 style="color: {% cycle '#8E24AA' '#D81B60' '#1E88E5' %}">{{ gender }}</h4>
                                <table class="cid-table">
                                    <thead>
                                        <tr>
                                            <th>Grupo Patológico (CID)</th>
                                            <th>Qtde</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cid in cids %}
                                        <tr>
                                            <td>{{ cid.grupo_patologico|truncatechars:25 }}</td>
                                            <td>{{ cid.count }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-3 text-muted">
                            <p>Dados insuficientes para análise por gênero</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        
        <section class="chart-card">
            <h2>Análise de Custos do Absenteísmo</h2>
            <div class="cost-analysis">
                <div class="cost-section">
                    <h3>Premissas de Cálculo</h3>
                    <div class="cost-grid">
                        <div class="cost-item">
                            <p class="cost-label">Salário Mínimo Brasil:</p>
                            <p class="cost-value">R$ 1.412,00</p>
                        </div>
                        <div class="cost-item">
                            <p class="cost-label">Horas Mensais:</p>
                            <p class="cost-value">176 horas</p>
                        </div>
                        <div class="cost-item">
                            <p class="cost-label">Valor Hora Base:</p>
                            <p class="cost-value">R$ {{ hourly_rate|floatformat:2 }}</p>
                        </div>
                        <div class="cost-item">
                            <p class="cost-label">Total Horas Afastadas:</p>
                            <p class="cost-value">{{ total_hours_off }} horas</p>
                        </div>
                    </div>
                </div>
                
                <div class="cost-section">
                    <h3>Custo por Setor</h3>
                    <div class="chart-container">
                        {% if cost_chart %}
                        <div id="cost-chart"></div>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-chart-bar fa-4x mb-3"></i>
                            <p>Dados insuficientes para gerar este gráfico</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="cost-section">
                    <h3>Custo Total do Absenteísmo</h3>
                    <div class="total-cost-box">
                        <p class="total-cost-value">R$ {{ absenteeism_cost|floatformat:2 }}</p>
                        <p class="cost-percent">Representa aproximadamente {{ absenteeism_rate|floatformat:2 }}% de horas trabalhadas</p>
                    </div>
                </div>
                
                <div class="cost-section">
                    <h3>Projeção de Economia</h3>
                    <div class="savings-grid">
                        <div class="savings-card">
                            <h4>Economia com redução de 10%</h4>
                            <p class="savings-value">R$ {{ savings_10|floatformat:2 }}</p>
                        </div>
                        <div class="savings-card">
                            <h4>Economia com redução de 20%</h4>
                            <p class="savings-value">R$ {{ savings_20|floatformat:2 }}</p>
                        </div>
                        <div class="savings-card">
                            <h4>Economia com redução de 30%</h4>
                            <p class="savings-value">R$ {{ savings_30|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <div class="mt-2">Processando dados...</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Carregar Plotly.js e Lodash -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

<!-- Renderizar os gráficos -->
<script>
// Esconder imediatamente o overlay quando o script começar a executar
(function() {
    var loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
})();

document.addEventListener('DOMContentLoaded', function() {
    // Esconder novamente o overlay (garantia dupla)
    var loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
    
    // Configurações globais do Plotly para estilo minimalista tipo shadcn
    const config = {
        displaylogo: false, // Remove o logo do Plotly
        responsive: true,
        modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
        toImageButtonOptions: {
            format: 'png',
            filename: 'syda_chart',
            height: 500,
            width: 700,
            scale: 2
        }
    };

    // Renderizar gráfico de unidades
    {% if units_chart %}
    Plotly.newPlot('units-chart', {{ units_chart|safe }}.data, {{ units_chart|safe }}.layout, config);
    {% endif %}
    
    // Renderizar gráfico de departamentos
    {% if departments_chart %}
    Plotly.newPlot('departments-chart', {{ departments_chart|safe }}.data, {{ departments_chart|safe }}.layout, config);
    {% endif %}
    
    // Renderizar gráfico de CID
    {% if cid_chart %}
    Plotly.newPlot('cid-chart', {{ cid_chart|safe }}.data, {{ cid_chart|safe }}.layout, config);
    {% endif %}
    
    // Renderizar gráfico mensal
    {% if month_chart %}
    Plotly.newPlot('month-chart', {{ month_chart|safe }}.data, {{ month_chart|safe }}.layout, config);
    {% endif %}
    
    // Renderizar gráfico de gênero
    {% if gender_chart %}
    Plotly.newPlot('gender-chart', {{ gender_chart|safe }}.data, {{ gender_chart|safe }}.layout, config);
    {% endif %}
    
    // Renderizar gráfico de custos
    {% if cost_chart %}
    Plotly.newPlot('cost-chart', {{ cost_chart|safe }}.data, {{ cost_chart|safe }}.layout, config);
    {% endif %}
    
    // Evento de redimensionamento para tornar os gráficos responsivos
    window.addEventListener('resize', function() {
        // Redimensionar todos os gráficos
        const charts = document.querySelectorAll('[id$="-chart"]');
        charts.forEach(chart => {
            Plotly.relayout(chart.id, {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        });
    });

    // Carregar os dados para os filtros
    function loadFilterOptions() {
        // Se tivéssemos dados disponíveis, preencheríamos os filtros aqui
        fetch('/employees/api/dashboard/employees/')
            .then(response => response.json())
            .then(data => {
                // Processo de dados dos funcionários para extrair as situações
                const situations = [...new Set(data.map(emp => emp.situacao).filter(Boolean))];
                const situationSelect = document.getElementById('situation-filter');
                
                // Limpa opções existentes
                situationSelect.innerHTML = '<option value="">Todas as Situações</option>';
                
                // Adiciona cada situação como uma opção
                situations.forEach(situation => {
                    const option = document.createElement('option');
                    option.value = situation;
                    option.textContent = situation;
                    situationSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Erro ao carregar dados dos funcionários:', error));

        fetch('/employees/api/dashboard/absences/')
            .then(response => response.json())
            .then(data => {
                // Extrair unidades e setores
                const units = [...new Set(data.map(abs => abs.unidade).filter(Boolean))];
                const departments = [...new Set(data.map(abs => abs.setor).filter(Boolean))];
                
                // Preencher select de unidades
                const unitSelect = document.getElementById('unit-filter');
                unitSelect.innerHTML = '<option value="">Todas as Unidades</option>';
                units.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                });
                
                // Preencher select de setores
                const deptSelect = document.getElementById('department-filter');
                deptSelect.innerHTML = '<option value="">Todos os Setores</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    deptSelect.appendChild(option);
                });
                
                // Definir datas mínima e máxima
                if (data.length > 0) {
                    const dates = data.map(item => item.dt_inicio_atestado).filter(Boolean).map(d => new Date(d));
                    if (dates.length > 0) {
                        const minDate = new Date(Math.min(...dates));
                        const maxDate = new Date(Math.max(...dates));
                        
                        document.getElementById('start-date').value = formatDateForInput(minDate);
                        document.getElementById('end-date').value = formatDateForInput(maxDate);
                    }
                }
            })
            .catch(error => console.error('Erro ao carregar dados de absenteísmo:', error));
    }

    // Função para formatar data para input (YYYY-MM-DD)
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Função para formatar data para exibição (DD/MM/YYYY)
    function formatDateForDisplay(dateStr) {
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }

    // Modificado para usar o form nativo do HTML
    // Manipulador para o botão de limpar filtros
    document.getElementById('reset-filters').addEventListener('click', function() {
        document.getElementById('filter-form').reset();
        loadFilterOptions(); // Recarregar as opções padrão
        
        // Atualizar URL sem parâmetros
        history.pushState({}, '', window.location.pathname);
        
        // Mostrar overlay ao recarregar
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
        
        // Recarregar página
        window.location.href = window.location.pathname;
    });

    // Mostrar overlay quando o formulário for enviado
    document.getElementById('filter-form').addEventListener('submit', function() {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
    });

    // Atualizar a exibição de filtros ativos
    function updateActiveFiltersDisplay(filters) {
        const activeFiltersEl = document.getElementById('active-filters');
        let filterText = '';
        let filtersApplied = false;
        
        if (filters.start_date && filters.end_date) {
            filterText += `<span class="badge bg-light text-dark me-2 mb-1">Período: ${formatDateForDisplay(filters.start_date)} a ${formatDateForDisplay(filters.end_date)}</span>`;
            filtersApplied = true;
        }
        
        if (filters.unit) {
            filterText += `<span class="badge bg-light text-dark me-2 mb-1">Unidade: ${filters.unit}</span>`;
            filtersApplied = true;
        }
        
        if (filters.department) {
            filterText += `<span class="badge bg-light text-dark me-2 mb-1">Setor: ${filters.department}</span>`;
            filtersApplied = true;
        }
        
        if (filters.situation) {
            filterText += `<span class="badge bg-light text-dark me-2 mb-1">Situação: ${filters.situation}</span>`;
            filtersApplied = true;
        }
        
        if (filters.search) {
            filterText += `<span class="badge bg-light text-dark me-2 mb-1">Busca: ${filters.search}</span>`;
            filtersApplied = true;
        }
        
        activeFiltersEl.innerHTML = filtersApplied 
            ? `<strong>Filtros aplicados:</strong> ${filterText}`
            : '<span class="text-muted">Nenhum filtro aplicado</span>';
            
        document.getElementById('filtered-records').innerHTML = 
            filtersApplied ? 'Os dados exibidos estão filtrados. Para ver todos os dados, clique em "Limpar Filtros".' : '';
    }

    // Carregar opções de filtros ao iniciar
    loadFilterOptions();
    
    // Verificar se há parâmetros na URL e aplicar como filtros iniciais
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.toString()) {
        // Para cada parâmetro na URL, definir o valor no campo de filtro correspondente
        urlParams.forEach((value, key) => {
            const element = document.getElementById(`${key.replace('_', '-')}-filter`);
            if (element) {
                element.value = value;
            }
        });
        
        // Se houver dates na URL
        if (urlParams.has('start_date')) {
            document.getElementById('start-date').value = urlParams.get('start_date');
        }
        if (urlParams.has('end_date')) {
            document.getElementById('end-date').value = urlParams.get('end_date');
        }
        
        // Atualizar a exibição dos filtros ativos
        updateActiveFiltersDisplay({
            start_date: urlParams.get('start_date'),
            end_date: urlParams.get('end_date'),
            unit: urlParams.get('unit'),
            department: urlParams.get('department'),
            situation: urlParams.get('situation'),
            search: urlParams.get('search')
        });
    }
});

// Para garantir caso a página seja carregada com overlay visível
window.onload = function() {
    var loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
};
</script>
{% endblock %}